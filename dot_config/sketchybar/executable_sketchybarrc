#!/opt/homebrew/bin/bash

source "$CONFIG_DIR/themes.sh"
PLUGIN_DIR="$CONFIG_DIR/plugins"

# Bar Appearance
sketchybar --bar position=top \
                 height=38 \
                 margin=0 \
                 y_offset=0 \
                 corner_radius=0 \
                 blur_radius="$BLUR_RADIUS" \
                 color=$BAR_COLOR \
                 shadow="$SHADOW_ENABLED" \
                 sticky=on \
                 padding_left=16 \
                 padding_right=16 \
                 notch_width=0

# Default Item Settings
default=(
  padding_left=0
  padding_right=0
  icon.font="$FONT_ICON"
  label.font="$FONT_LABEL"
  icon.color=$TEXT_PRIMARY
  label.color=$TEXT_PRIMARY
  icon.padding_left="$ICON_PADDING_LEFT"
  icon.padding_right="$ICON_PADDING_RIGHT"
  label.padding_left="$LABEL_PADDING_LEFT"
  label.padding_right="$LABEL_PADDING_RIGHT"
  background.color=$BG_PRIMARY
  background.corner_radius="$CORNER_RADIUS"
  background.height="$ITEM_HEIGHT"
  background.padding_left=0
  background.padding_right=0
)
sketchybar --default "${default[@]}"

# Workspaces

sketchybar --add event aerospace_workspace_change

declare -A workspace_labels
workspace_labels[9]="prv"

workspaces=(1 2 3 4 5 6 7 8 9)

for sid in "${workspaces[@]}"; do
    LABEL="$sid"
    [ -n "${workspace_labels[$sid]}" ] && LABEL="$sid ${workspace_labels[$sid]}"

    sketchybar --add item space.$sid left \
        --subscribe space.$sid aerospace_workspace_change \
        --set space.$sid \
        background.color=$BG_PRIMARY \
        background.corner_radius="$CORNER_RADIUS" \
        background.height="$ITEM_HEIGHT" \
        background.drawing=off \
        icon.drawing=off \
        label="$LABEL" \
        label.font="$FONT_LABEL" \
        label.color=$TEXT_PRIMARY \
        label.padding_left=10 \
        label.padding_right="$LABEL_PADDING_RIGHT" \
        padding_left=4 \
        padding_right=4 \
        click_script="aerospace workspace $sid" \
        script="$CONFIG_DIR/plugins/aerospace.sh $sid"
done

# Trigger initial update for all workspaces
sketchybar --trigger aerospace_workspace_change

# Front App

sketchybar --add item separator_left left \
           --set separator_left \
                 icon=│ \
                 icon.color=$BG_SECONDARY \
                 icon.font="$FONT_SEPARATOR" \
                 icon.padding_left=8 \
                 icon.padding_right=8 \
                 background.drawing=off \
                 label.drawing=off

sketchybar --add item front_app left \
           --set front_app \
                 icon= \
                 icon.color=$ACCENT_PRIMARY \
                 label.color=$TEXT_PRIMARY \
                 background.color=$BG_PRIMARY \
                 background.corner_radius=6 \
                 background.height=26 \
                 padding_left=4 \
                 padding_right=4 \
                  script="$PLUGIN_DIR/front_app.sh" \
            --subscribe front_app front_app_switched

# Theme Switcher

sketchybar --add item theme_switcher left \
           --set theme_switcher \
                 update_freq=0 \
                 icon.color=$ACCENT_PRIMARY \
                 label.color=$TEXT_PRIMARY \
                 background.color=$BG_PRIMARY \
                 background.corner_radius=6 \
                 background.height=26 \
                 padding_left=4 \
                 padding_right=4 \
                 click_script="$PLUGIN_DIR/theme_switcher_toggle.sh" \
                 script="$PLUGIN_DIR/theme_switcher.sh"

# System Status Items

sketchybar --add item clock right \
           --set clock \
                 update_freq=10 \
                 icon= \
                 icon.color=$ACCENT_PRIMARY \
                 label.color=$TEXT_PRIMARY \
                 background.color=$BG_PRIMARY \
                 background.corner_radius=6 \
                 background.height=26 \
                 padding_left=4 \
                 padding_right=4 \
                  script="$PLUGIN_DIR/clock.sh"

sketchybar --add item battery right \
           --set battery \
                 update_freq=120 \
                 background.color=$BG_PRIMARY \
                 background.corner_radius=6 \
                 background.height=26 \
                 padding_left=4 \
                 padding_right=4 \
                  script="$PLUGIN_DIR/battery.sh" \
            --subscribe battery system_woke power_source_change

sketchybar --add item volume right \
           --set volume \
                 label.color=$TEXT_PRIMARY \
                 background.color=$BG_PRIMARY \
                 background.corner_radius=6 \
                 background.height=26 \
                 padding_left=4 \
                 padding_right=4 \
                  script="$PLUGIN_DIR/volume.sh" \
            --subscribe volume volume_change

sketchybar --add event microphone_change \
           --add item microphone right \
           --set microphone \
                 update_freq=5 \
                 icon.color=$TEXT_PRIMARY \
                 label.color=$TEXT_PRIMARY \
                 background.color=$BG_PRIMARY \
                 background.corner_radius=6 \
                 background.height=26 \
                 padding_left=4 \
                 padding_right=4 \
                 click_script="$PLUGIN_DIR/microphone_toggle.sh" \
                  script="$PLUGIN_DIR/microphone.sh" \
            --subscribe microphone microphone_change

sketchybar --add item wifi right \
           --set wifi \
                 update_freq=10 \
                 background.color=$BG_PRIMARY \
                 background.corner_radius=6 \
                 background.height=26 \
                 padding_left=4 \
                 padding_right=4 \
                 click_script="$PLUGIN_DIR/wifi_toggle.sh" \
                  script="$PLUGIN_DIR/wifi.sh" \
           --subscribe wifi system_woke

sketchybar --add item inputlayout right \
           --add event inputlayout_change "AppleSelectedInputSourcesChangedNotification" \
                       --subscribe inputlayout inputlayout_change \
           --set inputlayout \
                 icon.drawing=off \
                 label.color=$TEXT_PRIMARY \
                 background.color=$BG_PRIMARY \
                 background.corner_radius=6 \
                 background.height=26 \
                 padding_left=4 \
                 padding_right=4 \
                  script="$PLUGIN_DIR/input_layout.sh"

sketchybar --add item lima right \
           --set lima \
                 update_freq=120 \
                 icon.drawing=off \
                 label.color=$TEXT_PRIMARY \
                 background.color=$BG_PRIMARY \
                 background.corner_radius=6 \
                 background.height=26 \
                 padding_left=4 \
                 padding_right=4 \
                 script="$PLUGIN_DIR/lima.sh"

sketchybar --add item orbstack right \
           --set orbstack \
                 update_freq=10 \
                 background.color=$BG_PRIMARY \
                 background.corner_radius=6 \
                 background.height=26 \
                 padding_left=4 \
                 padding_right=4 \
                 click_script="$PLUGIN_DIR/orbstack_toggle.sh" \
                 script="$PLUGIN_DIR/orbstack.sh" \
           --subscribe orbstack system_woke
sketchybar --update

echo "✓ SketchyBar configuration loaded"
